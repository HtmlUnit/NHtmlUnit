name: build

on: [push, pull_request]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
    env:
      NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - uses: gittools/actions/gitversion/setup@v0.9.13
        with:
          versionSpec: '5.x'

      - uses: gittools/actions/gitversion/execute@v0.9.13
        id: gitversion
        with:
          updateAssemblyInfo: true

      - uses: actions/cache@v2
        with:
          path: ${{ github.workspace }}/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: ${{ runner.os }}-nuget-

      - run: dotnet restore

      - run: dotnet run --configuration Release --no-restore --project app/NHtmlUnitGenerator/NHtmlUnit.Generator.csproj

      - run: dotnet build --configuration Release --no-restore

      - run: dotnet test --project tests/IntegrationTests/IntegrationTests.csproj --configuration Release --no-build --no-restore -p:CollectCoverage=true -p:CoverletOutputFormat=opencover -p:Exclude="[NHtmlUnit.Test*]*"

      - uses: codecov/codecov-action@v2

      - run: dotnet pack --include-source --configuration Release --no-build --no-restore -p:PackageVersion="${{ steps.gitversion.outputs.fullSemVer }}" app/NHtmlUnit/NHtmlUnit.csproj --output ${{ github.workspace }}/nugets/

      - uses: actions/upload-artifact@v3
        with:
          name: NHtmlUnit.nupkg
          path: ${{ github.workspace }}/nugets/*.nupkg

  release:
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/') # Only release tagged commits

    steps:
    - uses: actions/download-artifact@v3
      with:
        name: NHtmlUnit.nupkg

    - name: Upload .nupkg to release
      uses: meeDamian/github-release@2.0
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        files: '*.nupgk'
        allow_override: true

  publish:
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/') # Only publish tagged commits

    steps:
    - uses: actions/download-artifact@v3
      with:
        name: NHtmlUnit.nupkg

    - uses: NuGet/setup-nuget@v1.0.7

    - name: Publish To NuGet.org
      run: nuget push *.nupkg -Source nuget.org -ApiKey ${{ secrets.NUGET_API_KEY }}
